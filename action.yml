name: 'Update Changelog Action'
description: 'A GitHub Action to automatically update the changelog.'
author: 'Md. Musfiqur Rahaman'

branding:
    icon: "refresh-cw"
    color: "white"

inputs:
  version:
    description: 'Version number for the release.'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get the current version
      id: current-version
      run: echo "version=$(python setup.py --version)" >> $GITHUB_ENV
      shell: bash

    - name: Determine previous version
      id: previous-version
      run: |
        PREVIOUS_VERSION=$(git tag --sort=-v:refname | grep -E "^v[0-9]+(\.[0-9]+)*$" | sed '1!d')
        echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_ENV
      shell: bash

    - name: Check commit message
      run: |
        if [[ $(git log -1 --pretty=%B) != "Update changelog for v${{ inputs.version }}" ]]; then
          echo "Commit message does not match the release pattern."
          exit 1
        fi
      shell: bash

    - name: Update changelog
      if: contains(github.event.head_commit.message, 'Update changelog for v${{ inputs.version }}')
      run: |
        CHANGES=$(git log --pretty=format:"- %s (%h)" ${{ env.previous_version }}..HEAD)
        echo -e "# v${{ inputs.version }}\n## Changes\n$CHANGES" > CHANGELOG.md
        git config user.email "your-email@example.com"
        git config user.name "Your Name"
        git add CHANGELOG.md
        git commit -m "Update CHANGELOG.md with latest version by GitHub Action"
        git push
      shell: bash
